<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bóveda Cloud AES-256 (Llave Maestra)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #050505; color: white; margin: 0; overflow-x: hidden; }
        .glass { background: rgba(23, 23, 23, 0.9); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.05); }
        .btn-primary { background: white; color: black; font-weight: 900; }
        .btn-primary:hover { background: #e5e5e5; }
        .btn-press:active { transform: scale(0.95); }
        input:focus { outline: none; border-color: rgba(59, 130, 246, 0.5) !important; }
        .hidden { display: none !important; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 pb-24">
    
    <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6" id="app">
        <!-- Barra Lateral / Estado -->
        <div class="space-y-6">
            <div class="glass p-6 rounded-[2rem] shadow-2xl">
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center gap-2">
                        <i data-lucide="shield-check" class="text-blue-500 w-5 h-5"></i>
                        <span class="text-[10px] font-black uppercase tracking-widest text-neutral-500 italic">Cifrado Militar AES</span>
                    </div>
                    <button onclick="toggleModal('modal-config')" class="p-2 bg-neutral-900 rounded-xl border border-white/5 text-neutral-400 hover:text-white transition-colors">
                        <i data-lucide="settings" class="w-5 h-5"></i>
                    </button>
                </div>

                <div class="p-6 rounded-3xl mb-6 border border-blue-500/20 bg-blue-500/5">
                    <div class="flex items-center gap-2 mb-2 text-neutral-500 font-black text-[10px] uppercase">
                        <i data-lucide="clock" class="w-3 h-3"></i> Próximo Reporte
                    </div>
                    <div id="next-check-date" class="text-3xl font-mono font-black tracking-tighter">--/--/----</div>
                </div>

                <button id="master-btn" onclick="handleAccess()" class="w-full btn-primary py-4 rounded-2xl btn-press transition-all flex items-center justify-center gap-2 mb-4 shadow-xl">
                    <i data-lucide="lock" class="w-5 h-5"></i> <span id="btn-lock-text">DESBLOQUEAR</span>
                </button>

                <button onclick="syncWithGithub()" class="w-full bg-neutral-800 text-white text-[10px] font-black py-3 rounded-xl hover:bg-neutral-700 transition-all flex items-center justify-center gap-2">
                    <i data-lucide="refresh-cw" id="sync-icon" class="w-4 h-4"></i> SINCRONIZAR NUBE
                </button>
            </div>
        </div>

        <!-- Contenido de la Bóveda -->
        <div class="lg:col-span-2 space-y-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center glass p-8 rounded-[2.5rem] gap-4">
                <div>
                    <h1 class="text-3xl font-black tracking-tighter italic uppercase">Vault_Master</h1>
                    <p class="text-[10px] font-bold text-neutral-600 uppercase tracking-[0.3em] mt-1">Sincronizado vía GitHub Gist</p>
                </div>
                <button id="btn-new-entry" disabled onclick="toggleModal('modal-add')" class="bg-blue-600 disabled:opacity-30 text-white px-6 py-4 rounded-2xl font-black text-xs btn-press transition-all">
                    NUEVO REGISTRO
                </button>
            </div>

            <div id="vault-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4 min-h-[300px]">
                <!-- Los registros se cargan aquí -->
            </div>
        </div>
    </div>

    <!-- MODAL: PIN DE ACCESO -->
    <div id="modal-pin" class="fixed inset-0 bg-black/95 backdrop-blur-xl hidden flex items-center justify-center p-6 z-[100]">
        <div class="bg-neutral-900 border border-white/10 p-10 rounded-[3rem] w-full max-w-sm text-center shadow-2xl">
            <i data-lucide="key-round" class="w-12 h-12 mx-auto mb-4 text-blue-500"></i>
            <h3 class="text-xl font-black mb-2 uppercase tracking-tighter italic">Acceso Usuario</h3>
            <p class="text-[9px] text-neutral-500 uppercase font-bold mb-6 tracking-widest italic">Introduce tu PIN de 6 dígitos</p>
            
            <input id="pin-input" type="password" maxlength="6" autofocus
                class="w-full bg-black border border-white/10 rounded-2xl p-5 text-center text-4xl font-black outline-none focus:border-blue-500/50 tracking-[0.5em] mb-4">
            
            <button onclick="submitPin()" class="w-full btn-primary py-4 rounded-2xl text-xs uppercase btn-press mb-4">ACCEDER</button>
            
            <div class="border-t border-white/5 pt-4">
                <button onclick="showRecoveryUI()" class="text-neutral-600 font-bold text-[9px] uppercase hover:text-white transition-colors italic">¿Olvidaste tu PIN? Usar Llave Maestra</button>
            </div>
            <button onclick="toggleModal('modal-pin')" class="w-full text-neutral-800 font-bold text-[10px] uppercase mt-6">Cerrar</button>
        </div>
    </div>

    <!-- MODAL: RECUPERACIÓN MAESTRA -->
    <div id="modal-recovery" class="fixed inset-0 bg-black/98 backdrop-blur-2xl hidden flex items-center justify-center p-6 z-[200]">
        <div class="bg-neutral-900 border border-red-500/20 p-10 rounded-[3rem] w-full max-w-md shadow-2xl">
            <div class="text-center mb-6">
                <i data-lucide="shield-alert" class="w-12 h-12 mx-auto mb-4 text-red-500"></i>
                <h3 class="text-xl font-black uppercase italic tracking-tighter text-red-500">Modo Recuperación</h3>
                <p class="text-[9px] text-neutral-500 uppercase font-bold mt-2 tracking-widest">Sobrescribir seguridad actual</p>
            </div>
            <div class="space-y-4">
                <label class="text-[10px] font-black text-neutral-600 uppercase block ml-2">Tu Llave Maestra (Código de Emergencia)</label>
                <input id="recovery-key-input" type="text" class="w-full bg-black border border-white/10 rounded-xl p-4 text-center font-mono text-xs uppercase tracking-widest" placeholder="XXXX-XXXX-XXXX">
                <button onclick="verifyRecoveryKey()" class="w-full bg-red-600 text-white font-black py-4 rounded-2xl text-[10px] uppercase btn-press">REESTABLECER PIN</button>
                <button onclick="toggleModal('modal-recovery')" class="w-full text-neutral-600 font-bold text-[10px] uppercase pt-2">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- MODAL: CONFIGURACIÓN INICIAL (FIRST RUN) -->
    <div id="modal-setup" class="fixed inset-0 bg-black/98 backdrop-blur-2xl hidden flex items-center justify-center p-6 z-[150]">
        <div class="bg-neutral-900 border border-white/10 p-10 rounded-[3rem] w-full max-w-md shadow-2xl">
            <h3 class="text-2xl font-black mb-4 uppercase italic text-center">Configurar Bóveda</h3>
            <p class="text-neutral-400 text-xs mb-8 text-center px-4 leading-relaxed">Define tu PIN de 6 dígitos y guarda la **Llave Maestra** en un lugar físico. Sin ella, no hay forma de recuperar tus datos.</p>
            <div class="space-y-6">
                <div>
                    <label class="text-[10px] font-black text-neutral-600 uppercase ml-2 mb-2 block">Define tu PIN (6 dígitos)</label>
                    <input id="setup-pin" type="password" maxlength="6" class="w-full bg-black border border-white/10 rounded-2xl p-4 text-center text-3xl font-black">
                </div>
                <div class="p-6 bg-blue-500/5 border border-blue-500/20 rounded-2xl">
                    <label class="text-[10px] font-black text-blue-400 uppercase mb-2 block">Tu Llave Maestra Única</label>
                    <div id="display-master-key" class="text-lg font-mono font-black tracking-widest text-center select-all bg-white/5 py-3 rounded-xl cursor-pointer">...</div>
                    <p class="text-[8px] text-neutral-600 mt-3 text-center uppercase font-bold italic">Cópiala ahora. Es tu única forma de recuperación.</p>
                </div>
                <button onclick="finishSetup()" class="w-full btn-primary py-4 rounded-2xl uppercase text-xs btn-press">ACTIVAR BÓVEDA</button>
            </div>
        </div>
    </div>

    <!-- MODAL: AGREGAR REGISTRO -->
    <div id="modal-add" class="fixed inset-0 bg-black/90 backdrop-blur-md hidden flex items-center justify-center p-6 z-50">
        <div class="bg-neutral-900 border border-white/10 rounded-[3rem] w-full max-w-md p-10 shadow-2xl">
            <h3 class="text-xl font-black mb-6 italic uppercase tracking-tighter">Nuevo Registro</h3>
            <div class="space-y-4">
                <input id="new-site" class="w-full bg-black p-4 rounded-2xl border border-white/5 outline-none text-sm placeholder:text-neutral-700" placeholder="Sitio / App">
                <input id="new-user" class="w-full bg-black p-4 rounded-2xl border border-white/5 outline-none text-sm placeholder:text-neutral-700" placeholder="Usuario">
                <input id="new-pass" type="password" class="w-full bg-black p-4 rounded-2xl border border-white/5 outline-none text-sm placeholder:text-neutral-700" placeholder="Contraseña">
                <div class="flex gap-4 pt-4">
                    <button onclick="toggleModal('modal-add')" class="flex-1 font-bold text-neutral-600 text-[10px] uppercase">Cancelar</button>
                    <button onclick="saveEntry()" class="flex-1 bg-white text-black font-black py-4 rounded-2xl text-[10px] uppercase shadow-xl">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: CONFIG GITHUB -->
    <div id="modal-config" class="fixed inset-0 bg-black/95 backdrop-blur-xl hidden flex items-center justify-center p-6 z-[110]">
        <div class="bg-neutral-900 border border-white/10 p-10 rounded-[3rem] w-full max-w-md shadow-2xl">
            <h3 class="text-2xl font-black mb-6 text-center uppercase tracking-tighter italic">Vincular GitHub</h3>
            <div class="space-y-4">
                <input id="cfg-token" type="password" placeholder="GitHub Personal Access Token" class="w-full bg-black border border-white/10 rounded-2xl p-4 text-xs font-mono">
                <input id="cfg-gist" type="text" placeholder="Gist ID" class="w-full bg-black border border-white/10 rounded-2xl p-4 text-xs font-mono">
                <button onclick="saveConfig()" class="w-full btn-primary py-4 rounded-2xl text-[10px] uppercase font-black">GUARDAR CONFIGURACIÓN</button>
                <button onclick="toggleModal('modal-config')" class="w-full text-neutral-700 font-bold text-[10px] uppercase pt-4">Cerrar</button>
            </div>
        </div>
    </div>

    <script>
        let vaultData = { passwords: [], settings: { pinHash: null, recoveryHash: null, salt: "" } };
        let userMasterKey = null; 
        let config = JSON.parse(localStorage.getItem('gh_vault_config')) || { token: '', gistId: '' };

        // --- Utilidades Cripto ---
        function createHash(input, salt) { return CryptoJS.SHA256(input + salt).toString(); }
        function generateMasterKey() { return Array.from({length: 3}, () => Math.random().toString(36).substring(2, 6).toUpperCase()).join('-'); }

        // --- Sincronización ---
        async function syncWithGithub(dataToSave = null) {
            if (!config.token || !config.gistId) { alert("Configura GitHub primero."); return; }
            document.getElementById('sync-icon').classList.add('animate-spin');
            
            try {
                const url = `https://api.github.com/gists/${config.gistId}`;
                const response = await fetch(url, {
                    method: dataToSave ? 'PATCH' : 'GET',
                    headers: { 'Authorization': `token ${config.token}`, 'Content-Type': 'application/json' },
                    body: dataToSave ? JSON.stringify({ files: { "vault_data.json": { content: CryptoJS.AES.encrypt(JSON.stringify(dataToSave), userMasterKey).toString() } } }) : null
                });

                if (response.ok) {
                    const result = await response.json();
                    if (!dataToSave) {
                        const content = result.files["vault_data.json"].content;
                        if (content && userMasterKey) {
                            const decrypted = CryptoJS.AES.decrypt(content, userMasterKey).toString(CryptoJS.enc.Utf8);
                            if (decrypted) vaultData = JSON.parse(decrypted);
                        }
                    }
                    render();
                } else { throw new Error(); }
            } catch (e) { alert("Error de Sincronización. Revisa tu Token/Gist ID."); }
            document.getElementById('sync-icon').classList.remove('animate-spin');
        }

        // --- Lógica de Acceso ---
        function handleAccess() {
            if (!vaultData.settings.pinHash) {
                document.getElementById('display-master-key').innerText = generateMasterKey();
                toggleModal('modal-setup');
            } else {
                toggleModal('modal-pin');
            }
        }

        function finishSetup() {
            const pin = document.getElementById('setup-pin').value;
            const recovery = document.getElementById('display-master-key').innerText;
            if (pin.length !== 6) { alert("El PIN debe ser de 6 dígitos."); return; }
            
            const salt = CryptoJS.lib.WordArray.random(16).toString();
            vaultData.settings = {
                pinHash: createHash(pin, salt),
                recoveryHash: createHash(recovery, salt),
                salt: salt
            };
            userMasterKey = pin;
            syncWithGithub(vaultData);
            toggleModal('modal-setup');
        }

        function submitPin() {
            const pin = document.getElementById('pin-input').value;
            const hash = createHash(pin, vaultData.settings.salt);
            if (hash === vaultData.settings.pinHash) {
                userMasterKey = pin;
                syncWithGithub();
                toggleModal('modal-pin');
                document.getElementById('btn-lock-text').innerText = "BLOQUEAR";
            } else { alert("PIN Incorrecto."); }
        }

        function showRecoveryUI() {
            toggleModal('modal-pin');
            toggleModal('modal-recovery');
        }

        function verifyRecoveryKey() {
            const code = document.getElementById('recovery-key-input').value.trim().toUpperCase();
            const hash = createHash(code, vaultData.settings.salt);
            if (hash === vaultData.settings.recoveryHash) {
                const newPin = prompt("Identidad Confirmada. Ingresa tu NUEVO PIN (6 dígitos):");
                if (newPin && newPin.length === 6) {
                    vaultData.settings.pinHash = createHash(newPin, vaultData.settings.salt);
                    userMasterKey = newPin; 
                    syncWithGithub(vaultData);
                    alert("PIN actualizado con éxito.");
                    toggleModal('modal-recovery');
                }
            } else { alert("Llave Maestra Inválida."); }
        }

        // --- Gestión de Datos ---
        function saveEntry() {
            const site = document.getElementById('new-site').value;
            const user = document.getElementById('new-user').value;
            const pass = document.getElementById('new-pass').value;
            if (!site || !pass) return;
            vaultData.passwords.push({ id: Date.now(), site, user, pass });
            syncWithGithub(vaultData);
            toggleModal('modal-add');
            // Reset fields
            document.getElementById('new-site').value = '';
            document.getElementById('new-user').value = '';
            document.getElementById('new-pass').value = '';
        }

        function deleteEntry(id) {
            if (confirm("¿Eliminar este registro permanentemente?")) {
                vaultData.passwords = vaultData.passwords.filter(p => p.id !== id);
                syncWithGithub(vaultData);
            }
        }

        function saveConfig() {
            config.token = document.getElementById('cfg-token').value.trim();
            config.gistId = document.getElementById('cfg-gist').value.trim();
            localStorage.setItem('gh_vault_config', JSON.stringify(config));
            toggleModal('modal-config');
            alert("Servidor configurado.");
        }

        // --- UI ---
        function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); }

        function render() {
            const grid = document.getElementById('vault-grid');
            document.getElementById('btn-new-entry').disabled = !userMasterKey;
            
            if (!userMasterKey) {
                grid.innerHTML = `<div class="col-span-full py-20 text-center border border-dashed border-white/10 rounded-[2.5rem] uppercase text-[10px] text-neutral-500 italic tracking-widest">Bóveda Cifrada</div>`;
                return;
            }

            grid.innerHTML = vaultData.passwords.length === 0 ? '<div class="col-span-full text-center py-20 opacity-20 uppercase text-[10px] font-black italic">Sin Registros</div>' : '';
            vaultData.passwords.forEach(p => {
                grid.innerHTML += `
                    <div class="glass p-6 rounded-[2rem] border-white/5 animate-fade-in relative group">
                        <button onclick="deleteEntry(${p.id})" class="absolute top-4 right-4 text-neutral-800 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        <div class="text-[8px] font-black text-neutral-600 uppercase mb-2 tracking-widest">${p.site}</div>
                        <div class="text-[10px] font-bold text-neutral-400 mb-2">${p.user || 'Sin usuario'}</div>
                        <div class="bg-black/50 p-4 rounded-2xl flex justify-between items-center">
                            <span class="text-sm font-mono text-blue-400 tracking-widest">${p.pass}</span>
                            <i data-lucide="copy" class="w-3 h-3 text-neutral-700 cursor-pointer hover:text-white" onclick="navigator.clipboard.writeText('${p.pass}')"></i>
                        </div>
                    </div>`;
            });
            lucide.createIcons();
        }

        window.onload = () => { lucide.createIcons(); };
    </script>
</body>
</html>






